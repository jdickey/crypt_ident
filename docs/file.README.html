<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; crypt_ident Module Documentation
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1>CryptIdent</h1>

<p>Yet another fairly basic authentication Gem. (Authorisation, and batteries, sold separately.)</p>

<p>This is initially tied to Hanami 1.2.0+; specifically, it assumes that user entities have an API compatible with <code>Hanami::Entity</code> for accessing the field/attribute values listed below in <a href="#databaserepository-setup"><em>Database/Repository Setup</em></a> (which itself assumes a Repository API compatible with that of Hanami 1.2&#39;s Repository classes). The Gem is mostly a thin layer around <a href="https://github.com/codahale/bcrypt-ruby">BCrypt</a> that, in conjunction with Hanami entities or work-alikes, supports the most common use cases for password-based authentication:</p>

<ol>
<li><a href="#registration">Registration</a>;</li>
<li><a href="#signing-in">Signing in</a>;</li>
<li><a href="#signing-out">Signing out</a>;</li>
<li><a href="#password-change">Password change</a>;</li>
<li><a href="#password-reset">Password reset</a>; and</li>
<li><a href="#session-expiration">Session expiration</a>.</li>
</ol>

<p>It <em>does not</em> implement features such as</p>

<ol>
<li>Password-strength testing;</li>
<li>Password occurrence in a <a href="https://www.passwordrandom.com/most-popular-passwords">list of most popular (and easily hacked) passwords</a>; or</li>
<li>Password ageing (requiring password changes after a period of time).</li>
</ol>

<p>These either violate current best-practice recommendations from security leaders (e.g., NIST and others no longer recommend password ageing as a defence against cracking) or have other Gems that focus on the features in question (e.g., <a href="https://github.com/bdmac/strong_password"><code>bdmac/strong_password</code></a>).</p>

<h1>Installation</h1>

<p>Add this line to your application&#39;s Gemfile:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>crypt_ident</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>And then execute:</p>

<pre class="code ruby"><code class="ruby">$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre class="code ruby"><code class="ruby">$ gem install crypt_ident
</code></pre>

<h1>Usage</h1>

<h2>Database/Repository Setup</h2>

<p><code>CryptIdent</code> assumes that the repository used to read and update the underlying database table is named <code>UserRepository</code>; that can be changed using the <a href="#configuration"><em>Configuration</em></a> settings.</p>

<p>We further assume that the Repository object</p>

<ol>
<li>Has a <em>class method</em> named <code>.entity_name</code> that returns the name of the Entity used by that Repository <em>as a string</em> (e.g., <code>&quot;User&quot;</code> for a <code>UserRepository</code>);</li>
<li>Has a class method named <code>.guest_user</code> that returns an Entity with a descriptive name (e.g., &quot;Guest User&quot;) and is otherwise invalid for persistence (e.g., it has an invalid <code>id</code> attribute); and</li>
<li>Implements the &quot;usual&quot; common methods (<code>#create</code>, <code>#update</code>, <code>#delete</code>, etc) conforming to an interface compatible with <a href="https://github.com/hanami/model/blob/master/lib/hanami/repository.rb"><code>Hanami::Repository</code></a>. This interface is suitably generic and sufficiently widely implemented, even in ORMs such as ActiveRecord that make no claim to implementing the <a href="https://8thlight.com/blog/mike-ebert/2013/03/23/the-repository-pattern.html">Repository Pattern</a>.</li>
</ol>

<p>The database table for that Repository <strong>must</strong> have the following fields, in any order within the schema:</p>

<table><thead>
<tr>
<th style="text-align: left">Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code>name</code></td>
<td>string</td>
<td>The name of an individual User to be Authenticated</td>
</tr>
<tr>
<td style="text-align: left"><code>email</code></td>
<td>string</td>
<td>The Email Address for that User, to be used for Password Recovery, for example.</td>
</tr>
<tr>
<td style="text-align: left"><code>password_hash</code></td>
<td>text</td>
<td>The <em>encrypted</em> Password associated with that User.</td>
</tr>
<tr>
<td style="text-align: left"><code>password_reset_sent_at</code></td>
<td>timestamp without time zone</td>
<td>Defaults to <code>nil</code>; set this to the current time (<code>Time.now</code>) when responding to a Password Reset request (e.g., by email). The <code>token</code> (below) will expire at this time offset by the <code>reset_expiry</code> configuration value (see <em>Configuration</em>, below).</td>
</tr>
<tr>
<td style="text-align: left"><code>token</code></td>
<td>text</td>
<td>Defaults to <code>nil</code>. A Password Reset Token; a URL-safe secure random number (see <a href="https://ruby-doc.org/stdlib-2.5.1/libdoc/securerandom/rdoc/Random/Formatter.html#method-i-urlsafe_base64">standard-library documentation</a>) used to uniquely identify a Password Reset request.</td>
</tr>
</tbody></table>

<h2>Configuration</h2>

<p>The currently-configurable details for <code>CryptIdent</code> are as follows:</p>

<table><thead>
<tr>
<th style="text-align: left">Key</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code>error_key</code></td>
<td><code>:error</code></td>
<td>Modify this setting if you want to use a different key for flash messages reporting unsuccessful actions.</td>
</tr>
<tr>
<td style="text-align: left"><code>guest_user</code></td>
<td>Return value from <code>repository</code> <code>.guest_user</code> method</td>
<td>This value is used for the session variable <code>session[:current_user]</code> when no User has <a href="#signing-in">signed in</a>, or after a previously Authenticated User has <a href="#signing-out">signed out</a>. If your application <em>does not</em> make use of the <a href="https://en.wikipedia.org/wiki/Null_object_pattern">Null Object pattern</a>, you would assign <code>nil</code> to this configuration setting. (See <a href="https://robots.thoughtbot.com/rails-refactoring-example-introduce-null-object">this Thoughtbot post</a> for a good discussion of Null Objects in Ruby.)</td>
</tr>
<tr>
<td style="text-align: left"><code>hashing_cost</code></td>
<td>8</td>
<td>This is the <a href="https://github.com/codahale/bcrypt-ruby#cost-factors">hashing cost</a> used to <em>encrypt a password</em> and is applied at the hashed-password-creation step; it <strong>does not</strong> modify the default cost for the encryption engine. <strong>Note that</strong> any change to this value <strong>will</strong> invalidate and make useless all existing Encrypted Password stored values.</td>
</tr>
<tr>
<td style="text-align: left"><code>:repository</code></td>
<td><code>UserRepository.new</code></td>
<td>Modify this if your user records are in a different (or namespaced) class.</td>
</tr>
<tr>
<td style="text-align: left"><code>:reset_expiry</code></td>
<td>86400</td>
<td>Number of seconds from the time a password-reset request token is stored before it becomes invalid.</td>
</tr>
<tr>
<td style="text-align: left"><code>:session_expiry</code></td>
<td>900</td>
<td>Number of seconds <em>from either</em> the time that a User is successfully Authenticated <em>or</em> the <code>restart_session_counter</code> method is called <em>before</em> a call to <code>session_expired?</code> will return <code>true</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code>:success_key</code></td>
<td><code>:success</code></td>
<td>Modify this setting if you want to use a different key for flash messages reporting successful actions.</td>
</tr>
<tr>
<td style="text-align: left"><code>:token_bytes</code></td>
<td>16</td>
<td>Number of bytes of random data to generate when building a password-reset token. See <code>token</code> in the <a href="#databaserepository-setup"><em>Database/Repository Setup</em></a> section, above.</td>
</tr>
</tbody></table>

<p>For example</p>

<pre class="code ruby"><code class="ruby">  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>
  <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure_crypt_id'>configure_crypt_id</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_repository'>repository</span> <span class='op'>=</span> <span class='const'>MainApp</span><span class='op'>::</span><span class='const'>Repositories</span><span class='op'>::</span><span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='comment'># note: *not* a Hanami recommended practice!
</span>    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_error_key'>error_key</span> <span class='op'>=</span> <span class='symbol'>:alert</span>
    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_hashing_cost'>hashing_cost</span> <span class='op'>=</span> <span class='int'>6</span> <span class='comment'># less secure and less resource-intensive
</span>    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_token_bytes'>token_bytes</span> <span class='op'>=</span> <span class='int'>20</span>
    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_reset_expiry'>reset_expiry</span> <span class='op'>=</span> <span class='int'>7200</span> <span class='comment'># two hours; &quot;we run a tight ship here&quot;
</span>    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_guest_user'>guest_user</span> <span class='op'>=</span> <span class='const'>UserRepository</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_guest_user'>guest_user</span>
  <span class='kw'>end</span>
</code></pre>

<p>would change the configuration as you would expect whenever that code was run. (We <strong>recommend</strong> that this be done inside the <code>controller.prepare</code> block of your Hanami <code>web</code> (or equivalent) app&#39;s <code>application.rb</code> file.)</p>

<h2>Introductory Notes on Workflows</h2>

<h3>Session Handling Not Automatic</h3>

<p>If you&#39;ve set up your <code>controller.prepare</code> block as <strong>recommended</strong> in the preceding section, <code>CryptIdent</code> is loaded and configured but <em>does not</em> implement session-handling &quot;out of the box&quot;; as with <a href="https://github.com/sebastjan-hribar/tachiban#session-handling">other libraries</a>, it must be implemented <em>by you</em> as described in the <a href="#session-expiration"><em>Session Expiration</em></a> description below.</p>

<h3>Code Samples in API Reference are Authoritative</h3>

<p>Only minimal code snippets are included here to help explain use cases.  However, the <a href="docs/CryptIdent.html">API Reference</a> should be considered authoritative; any discrepancies between the API and/or code snippets there and here should be regarded as a bug (and a <a href="https://github.com/jdickey/crypt_ident/issues/">report</a> filed if not already filed.</p>

<h3>Terminology and the project Ubiquitous Language</h3>

<p>Finally, a note on terminology. Terms that have meaning (e.g., <em>Guest User</em>) within this module&#39;s domain language, or <a href="https://www.martinfowler.com/bliki/UbiquitousLanguage.html">Ubiquitous Language</a>, <strong>must</strong> be capitalised, at least on first use within a paragraph. This is to stress to the reader that, while these terms may have &quot;obvious&quot; meanings, their use within this module and its related documents (including this one) <strong>should</strong> be consistent, specific, and rigorous in their meaning. In the <a href="docs/CryptIdent.html">API Documentation</a>, each of these terms <strong>must</strong> be listed in the <em>Ubiquitous Language Terms</em> section under each method description in which they are used.</p>

<p>After the first usage in a paragraph, the term <strong>may</strong> be used less strictly (e.g., by referring to a <em>Clear-Text Password</em> simply as a <em>password</em> <em>if</em> doing so does not introduce ambiguity or confusion. The reader should feel free to <a href="https://github.com/jdickey/cript_ident/issues">open an issue report</a> if you spot any lapses. (Thank you!)</p>

<h2>Use-Case Workflows</h2>

<h3>Registration</h3>

<h4>Overview</h4>

<p>Method involved:</p>

<pre class="code ruby"><code class="ruby">  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_sign_up'>sign_up</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='label'>current_user:</span><span class='comma'>,</span> <span class='label'>repo:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>on_error:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_on_success'>on_success</span><span class='rparen'>)</span>
      <span class='comment'># ...
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
</code></pre>

<p>This is the first of our use cases that involves calling a function which expects a block to be supplied; if one isn&#39;t, then a log-format warning message will remind you of the error.</p>

<p>The <code>params</code> parameter is a Hash-like object such as a <code>Hanami::Action::Params</code> instance. It <strong>must</strong> have a <code>:name</code> entry, as well as any other keys and matching field values required by the Entity which will be created from the <code>params</code> values, <em>other than</em> a <code>:password_hash</code> key. It <strong>should</strong> have a <code>:password</code> entry; if none is specified, then a <em>random</em> <code>:password_hash</code> attribute (rather than one created by encrypting the <code>:password</code>) will be assigned to the resulting Entity.</p>

<p>Pass in the value of the <code>session[:current_user]</code> session variable as the <code>:current_user</code> parameter. This <strong>should</strong> be an Entity value; if it is an integer, it will be used as an <code>id</code> to <code>#find</code> from the Repository in use by the method.</p>

<p>If a Repository instance different than that loaded by the <a href="#configuration"><em>Configuration</em></a> is to be used, pass it in as the <code>repo:</code> parameter. Leaving the default value, <code>nil</code>, <strong>should</strong> work in a properly-designed application.</p>

<p>To have the <code>#sign_up</code> method call a Callable (<code>Proc</code> or lambda) when an error is detected, supply it as the <code>on_error:</code> parameter. The parameters to be passed to it include</p>

<ol>
<li>an error ID Symbol, which will also be the value returned by the <code>#sign_up</code> method itself;</li>
<li>the <code>params</code> passed to the <code>#sign_up</code> method;</li>
<li>a <span class='object_link'><a href="CryptIdent/Config.html" title="CryptIdent::Config (class)">CryptIdent::Config</a></span> instance describing the active configuration values;</li>
<li>a Hash of any other information relevant to the error; this will be documented in the <a href="file.CryptIdent.html" title="API Guide">API Guide</a> when relevant, defaulting to an empty Hash otherwise.</li>
</ol>

<p>The block associated with the <code>#sign_up</code> call (documented as <code>&amp;on_success</code> above) will be called <em>if and only if</em> the method is successful (and returns a User instance). The block <strong>must</strong> accept two parameters:</p>

<ol>
<li>the User Entity that was created; and</li>
<li>a <span class='object_link'><a href="CryptIdent/Config.html" title="CryptIdent::Config (class)">CryptIdent::Config</a></span> instance describing the active configuration values.</li>
</ol>

<p>These will be further described below:</p>

<h4>Success, aka Golden Path</h4>

<p>If the <code>params</code> include all values required by the underlying schema, including a valid <code>name</code> attribute that does not exist in the underlying data store, and an entry for <code>password</code>, then the specified <code>password</code> will be encrypted into a URL-safe string and used for the <code>password_hash</code> attribute of the new Entity. If the <code>password</code> is <code>nil</code>, empty, or blank, the resulting<code>password_hash</code> attribute will be randomised, requiring a <a href="#password-reset"><em>Password Reset</em></a> before the user can <a href="#signing-in"><em>Sign In</em></a>.</p>

<p>The <code>&amp;on_success</code> block will be called with the newly-created User Entity and Config object as parameters. This would typically be used to define UI interactions such as flash messages, redirection, and so on.</p>

<h4>Error Conditions</h4>

<h5>Authenticated User as <code>current_user:</code> Parameter</h5>

<p>If the specified <code>current_user:</code> parameter is a valid User instance or ID, then that is presumed to be the Current User of the application. Authenticated Users are prohibited from creating other Users, and so the call will fail and return <code>:current_user_exists</code>. This will also be the error ID passed to any defined <code>on_error:</code> handler.</p>

<h5>Specified <code>:name</code> Attribute Already Used for an Existing User</h5>

<p>If the specified <code>:name</code> attribute exists in a record within the Repository, then the call will fail and the returned error ID will be <code>:user_already_created</code>.</p>

<h5>Record Could Not be Created Within Repository</h5>

<p>If the Repository method <code>#create</code> returned an error, then the call will fail and the returned error ID will be <code>:user_creation_failed</code>.</p>

<h3>Signing In -- TODO: FIXME</h3>

<h4>Overview</h4>

<p>Method involved:</p>

<pre class="code ruby"><code class="ruby">  module CryptIdent
    def sign_in(params, current_user:, repo: nil, on_error: nil, &amp;on_success)
      # ...
    end

</code></pre>

<p>Once a user has been <a href="#registration">Registered</a>, signing in is a matter of retrieving that user&#39;s Entity (containing a <code>password_hash</code> attribute) and calling <code>#sign_in</code> passing in that Entity and the supplied clear-text password, and seeing what the return value is.</p>

<p>If the supplied clear-text password is <em>incorrect</em>, then <code>#sign_in</code> will return <code>nil</code>.</p>

<p>If it is <em>correct</em>, then the return value will be <code>true</code>.</p>

<p><strong>Note that</strong> <code>#sign_in</code> interacts with session data if available. (In unit tests, it often is not.) Specifically:</p>

<p>On <em>success</em>:</p>

<ul>
<li><code>session[:start_time]</code> is set to the current time as returned by <code>Time.now</code> when called from within the method;</li>
<li><code>session[:current_user]</code> is set to the <em>Entity</em> (not the ID value from the Repository) for the now-logged-in user.  This is to eliminate repeated reads of the Repository.</li>
</ul>

<p>On <em>failure</em>:</p>

<ul>
<li><code>session[:start_time]</code> is set to <code>0000-01-01 00:00:00 +0000</code>;</li>
<li><code>session[:current_user]</code> is set to <a href="#configuration"><code>config.guest_user</code></a>.</li>
</ul>

<p>If a <em>different user</em> is logged in (as evidenced by <code>session[:current_user]</code>), then <code>#sign_in</code> returns <code>false</code> and the <code>session</code> data remains unchanged.</p>

<h3>Signing Out -- TODO: FIXME</h3>

<p>Signing out a previously Authenticated user is straightforward: call the <code>sign_out</code> method.</p>

<p>If the <code>session[:current_user]</code> value <em>does not</em> have the value of <a href="#configuration"><code>config.guest_user</code></a>, <code>session[:start_time]</code> is set to <code>0000-01-01 00:00:00 +0000</code>, and the method returns <code>true</code>.</p>

<p>If <code>session[:current_user]</code> <em>is</em> the Guest User, then <code>session[:start_time]</code> is cleared as above, and the method returns <code>false</code>.</p>

<p>In neither case is any data but the <code>session</code> values affected.</p>

<h3>Password Change -- TODO: FIXME</h3>

<p>To change an <a href="#signing-in">authenticated</a> user&#39;s password, the current clear-text password, new clear-text password, and clear-text password confirmation are passed to <code>change_password</code>.</p>

<p>If the Encrypted Password in the <code>session[:current_user]</code> entity does not match the encrypted value of the specified current Clear-Text Password, then the method returns <code>:bad_password</code> and no changes occur.</p>

<p>If the current-password check succeeds but the new Clear-Text Password and its confirmation do not match, then the method returns <code>:mismatched_password</code> and no changes occur.</p>

<p>If the new Clear-Text Password and its confirmation match, then the <em>encrypted value</em> of that new password is returned, and the <code>session[:current_user]</code> Entity is replaced with an Entity identical except that it has the new encrypted value for <code>password_hash</code>.</p>

<h3>Password Reset -- TODO: FIXME</h3>

<p>To reset a User&#39;s password when the User <em>is not</em> <a href="#signing-in">authenticated</a> is a two-step process:</p>

<ol>
<li>Request that a password-reset link be sent to the email address associated with an individual user; and</li>
<li>Visit the unique link in the email sent in response to the first step to actually change the password.</li>
</ol>

<h4>Request a reset-password-link email message</h4>

<p>Password Reset Tokens are useful for verifying that the person requesting a Password Reset for an existing User is sufficiently likely to be the person who Registered that User or, if not, that no compromise or other harm is done.</p>

<p>Typically, this is done by sending a link through email or other such medium to the address previously associated with the User purportedly requesting the Password Reset. <code>CryptIdent</code> <em>does not</em> automate generation or sending of the email message. What it <em>does</em> provide is a method to generate a new Password Reset Token to be embedded into an HTML anchor link within an email
that you construct.</p>

<p>It also implements an expiry system, such that if the confirmation of the Password Reset request is not completed within a <a href="#Configuration">configurable</a> time, that the token is no longer valid (and cannot be later reused by unauthorised persons).</p>

<h4>Actually reset the password</h4>

<p>The <code>reset_password</code> method is called with the reset token encoded into the URL from the email in the preceding step, along with the clear-text new password and new-password confirmation parameters supplied to the action.</p>

<p>If the token is invalid or has expired, <code>reset_password</code> returns <code>:invalid_token</code> and no changes occur.</p>

<p>If the new password and confirmation do not match, <code>reset_password</code> returns <code>:mismatched_password</code> and no changes occur.</p>

<p>If the clear-text new password and its confirmation match, then the hashed value of that new password is returned, and the <code>session[:current_user]</code> Entity is replaced with an Entity identical except that it has the new value for <code>password_hash</code>.</p>

<h3>Session Expiration -- TODO: FIXME</h3>

<p>Session management is a necessary part of implementing authentication (and authorisation) within an app. However,  it&#39;s not something that an authentication <em>library</em> can fully implement without making the client application excessively inflexible and brittle.</p>

<p><code>CryptIdent</code> has two convenience methods which <em>help in</em> implementing session-expiration logic; these make use of the <code>session_expiry</code> <a href="#configuration">configuration value</a>.</p>

<ul>
<li><code>CryptIdent#restart_session_counter</code> resets the session-expiry time to the current time <em>plus</em> the number of seconds specified by the <code>session_expiry</code> configuration value.</li>
<li><code>CryptIdent#session_expired?</code> returns <code>true</code> if the current time is not less than the session-expiry time; it returns <code>false</code> otherwise.</li>
</ul>

<p>Example code which uses these methods is illustrated below, as a shared-code module that may be included in your controllers&#39; action classes:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># apps/web/controllers/handle_session.rb
</span>
<span class='kw'>module</span> <span class='const'>Web</span>
  <span class='kw'>module</span> <span class='const'>HandleSession</span>
    <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>

    <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_included'>included</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_class_eval'>class_eval</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_before'>before</span> <span class='symbol'>:validate_session</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_private'>private</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_validate_session'>validate_session</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_restart_session_counter'>restart_session_counter</span> <span class='kw'>unless</span> <span class='id identifier rubyid_session_expired?'>session_expired?</span>

      <span class='ivar'>@redirect_url</span> <span class='op'>||=</span> <span class='id identifier rubyid_routes'>routes</span><span class='period'>.</span><span class='id identifier rubyid_root_path'>root_path</span>
      <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:current_user</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_guest_user'>guest_user</span>
      <span class='id identifier rubyid_error_message'>error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Your session has expired. You have been signed out.</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_error_key'>error_key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_error_message'>error_message</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@redirect_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>This code should be fairly self-explanatory. Including the module adds the private <code>#validate_session</code> method to the client controller action class, adding a call to that method before the action class&#39; <code>#call</code> method is entered. If the session-expiry time has been previously set and is not before the current time, then that session-expiry time is reset based on the current time, and no further action is taken. Otherwise:</p>

<ol>
<li>The <code>current_user</code> setting in the session data is overwritten with the <a href="#configuration"><code>config.guest_user</code></a> value (defaulting to <code>nil</code>);</li>
<li>A flash error message is set, which <strong>should</strong> be rendered within the controller action&#39;s view; and</li>
<li>Control is redirected to the path or URL specified by <code>@redirect_url</code>, defaulting to the root path (<code>/</code>).</li>
</ol>

<p>This code will be instantly familiar to anyone coming from another framework like Rails, where the conventional way to ensure authentication before a controller action is executed is to add a <code>:before</code> hook. Adding this module to the controller action class is also justifiable Hanami, since it depends on and interacts with session data. (Just don&#39;t let any actual domain logic <a href="http://hanamirb.org/guides/1.2/actions/control-flow/#proc">taint</a> your controller callbacks; that&#39;s begging for difficult-to-debug problems going forward.</p>

<h1>API Documentation</h1>

<p>See <a href="./docs/index.html">the Documentation Index</a></p>

<h1>Development</h1>

<p>After checking out the repo, run <code>bin/setup</code> to install dependencies. If you use <a href="https://github.com/rbenv/rbenv"><code>rbenv</code></a> and <a href="https://github.com/jf/rbenv-gemset"><code>rbenv-gemset</code></a>, the <code>setup</code> script will create a new Gemset (in <code>./tmp/gemset</code>) to keep your system Gem repository pristine. Then, run <code>bin/rake test</code> to run the tests, or <code>bin/rake</code> without arguments to run tests and all static-analysis tools (<a href="https://github.com/seattlerb/flog">Flog</a>, <a href="https://github.com/seattlerb/flay">Flay</a>, <a href="https://github.com/troessner/reek">Reek</a>, and <a href="https://github.com/rubocop-hq/rubocop/">RuboCop</a>). Running <code>bin/rake inch</code> will let <a href="http://trivelop.de/inch/">Inch</a> comment on the amount of internal documentation in the project.</p>

<p>You can also run <code>bin/console</code> for an interactive prompt that will allow you to experiment.</p>

<p>To install this gem onto your local machine, run <code>bin/rake install</code> or <code>bundle exec rake install</code>. To release a new version, update the version number in <code>version.rb</code>, and then run <code>bin/rake release</code> or <code>bundle exec rake release</code>, which will create a Git tag for the version, push Git commits and tags, and push the <code>.gem</code> file to <a href="https://rubygems.org">rubygems.org</a>.</p>

<h1>Contributing</h1>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/jdickey/crypt_ident">https://github.com/jdickey/crypt_ident</a>. This project is intended to be a safe, welcoming space for collaboration, and contributors are expected to adhere to the <a href="http://contributor-covenant.org">Contributor Covenant</a> code of conduct.</p>

<h1>License</h1>

<p>The gem is available as open source under the terms of the <a href="https://opensource.org/licenses/MIT">MIT License</a>.</p>

<h1>Code of Conduct</h1>

<p>Everyone interacting in the CryptIdent projectâ€™s codebases, issue trackers, chat rooms and mailing lists is expected to follow the <a href="https://github.com/jdickey/crypt_ident/blob/master/CODE_OF_CONDUCT.md">code of conduct</a>.</p>
</div></div>

      <div id="footer">
  Generated on Sat Nov 10 03:28:57 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.16 (ruby-2.5.3).
</div>

    </div>
  </body>
</html>